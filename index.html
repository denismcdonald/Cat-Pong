<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Pong</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Monoton" rel="stylesheet">
</head>
<body>

    <div id="umpire"></div>

    <div id="eyeleft">
        <div id="eyebrowLeft"></div>
    </div>
    
    <div id="eyeright">
        <div id="eyebrowRight"></div>
    </div>

    <div id="nose">
        <div id="whiskers1"></div>
        <div id="whiskers2"></div>
        <div id="whiskers3"></div>
        <div id="whiskers4"></div>
        <div id="whiskers5"></div>
        <div id="whiskers6"></div>
    </div>

    <div id="scores">
        <h1 id="p1Score">0</h1>
        <!-- <h1 id="score">Score</h1> -->
        <h1 id="p2Score">0</h1>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <script type="text/javascript">

        // document.body.style.background = "yellow";

        var canvas;
        var ctx;
        var ballX = 400;
        var ballY = 300;
        var ballSpeedX = 10;        
        var ballSpeedY = 5;
        var rand = 5500;
        
        var player1Score = 0;
        var player2Score = 0;

        var paddle1Y = 250;
        var paddle2Y = 250;
        var paddleHeight = 100;
        var paddleWidth = 12;

        
        function calculateMousePosition(evt) {
            var rect = canvas.getBoundingClientRect();
            var root = document.documentElement;
            var mouseX = evt.clientX - rect.left - root.scrollLeft;
            var mouseY = evt.clientY - rect.top - root.scrollTop;
            return {
                x:mouseX,
                y:mouseY
            }            
        };       

        window.onload = function() {
            canvas = document.getElementById("gameCanvas");
            ctx = canvas.getContext("2d");
            var framesPerSecond = 59;

            //Smooth animation method, as per https://css-tricks.com/using-requestanimationframe/
            function repeatOften() {
                moveEverything();
                drawEverything();
                requestAnimationFrame(repeatOften);
            }
            repeatOften();            

            //Previous animation method, as per Udemy tutorial
            // setInterval(function() {
            //     moveEverything();
            //     drawEverything();
            // }, 1000/framesPerSecond);

            canvas.addEventListener("mousemove", 
                function(evt) {
                    var mousePos = calculateMousePosition(evt);
                    paddle1Y = mousePos.y-(paddleHeight/2);
            });

            //Blink cat's eyes
            setInterval(function blink() {
               document.getElementById("eyeleft").style.transition = "all 50ms ease-out";
               document.getElementById("eyeleft").style.height = "2px";
               document.getElementById("eyebrowLeft").style.transform = "skew(0,0deg)";
               document.getElementById("eyeright").style.transition = "all 50ms ease-out";
               document.getElementById("eyeright").style.height = "2px";
               document.getElementById("eyebrowRight").style.transform = "skew(0,0deg)";
               
               setTimeout(function() {
               document.getElementById("eyeleft").style.transition = "all 50ms ease-out";
               document.getElementById("eyeleft").style.height = "15px";
               document.getElementById("eyebrowLeft").style.transform = "skew(0,-20deg)";
               document.getElementById("eyeright").style.transition = "all 50ms ease-out";
               document.getElementById("eyeright").style.height = "15px";              
               document.getElementById("eyebrowRight").style.transform = "skew(0,20deg)";
               }, 150);
            }, rand);
        }  //window.onload 


        function ballReset() {
            
            ballSpeedX = -ballSpeedX;
            ballSpeedY = ballSpeedY/3;
            ballX = canvas.width/2;
            ballY = canvas.height/2;

            //Canvas reaction to score
            document.querySelector("canvas").classList.add("shake");
            setTimeout(function() {
            document.querySelector("canvas").classList.remove("shake");
            }, 1000);

            document.getElementById("nose").style.top = "125px";
            document.getElementById("eyeleft").style.transition = "all 50ms ease-out";
            document.getElementById("eyeleft").style.height = "2px";
            document.getElementById("eyebrowLeft").style.transform = "skew(0,15deg)";
            document.getElementById("eyeright").style.transition = "all 50ms ease-out";
            document.getElementById("eyeright").style.height = "2px";
            document.getElementById("eyebrowRight").style.transform = "skew(0,-15deg)";

            setTimeout (function() {
                document.getElementById("nose").style.top = "135px";
                document.getElementById("eyeleft").style.transition = "all 50ms ease-out";
                document.getElementById("eyeleft").style.height = "15px";
                document.getElementById("eyebrowLeft").style.transform = "skew(0,-20deg)";
                document.getElementById("eyeright").style.transition = "all 50ms ease-out";
                document.getElementById("eyeright").style.height = "15px";
                document.getElementById("eyebrowRight").style.transform = "skew(0,20deg)";
            }, 800);               
        }

        //Perhaps try implementing setTimeout for random interval instead?  https://stackoverflow.com/questions/30725455/change-setinterval-value-dynamically


        function computerMovement() {
            
            var paddle2YCenter = paddle2Y + (paddleHeight/2);
            
            if (paddle2YCenter < ballY-35) {
                paddle2Y += 5;
            } else if (paddle2YCenter > ballY+35) {
                paddle2Y -= 5;
            }
        }


        function moveEverything() {

            computerMovement();

            ballX += ballSpeedX;
            ballY += ballSpeedY;
            
            if (ballX < 0) {
                if (ballY > paddle1Y-10 && ballY < paddle1Y+paddleHeight+10) {
                    ballSpeedX = -ballSpeedX;
                    
                    //Calculates variable ball speed depending on collision point with paddle
                    var deltaY = ballY-(paddle1Y+paddleHeight/2);
                    ballSpeedY = deltaY * 0.35;

                } else {       
                    ballReset();
                    player2Score++;
                    document.getElementById("p2Score").innerHTML = player2Score; 
                    document.getElementById("p2Score").classList.add("grow");
                    setTimeout(function() {
                    document.getElementById("p2Score").classList.remove("grow");
                    }, 2000);
                }
            }

            if (ballX > canvas.width) {
                if (ballY > paddle2Y && ballY < paddle2Y+paddleHeight) {
                    ballSpeedX = -ballSpeedX;
                    
                    var deltaY = ballY-(paddle2Y+paddleHeight/2);
                    ballSpeedY = deltaY * 0.35;

                } else {                
                    ballReset();
                    player1Score++;
                    document.getElementById("p1Score").innerHTML = player1Score;
                    
                    document.getElementById("p1Score").classList.add("grow");
                    setTimeout(function() {
                        document.getElementById("p1Score").classList.remove("grow");
                    }, 2000);

                    document.querySelector("canvas").classList.add("cheer");
                    setTimeout(function() {
                        document.querySelector("canvas").classList.remove("cheer");
                    }, 1000);
                }
            }
            
            if (ballY < 0) {
                ballSpeedY = -ballSpeedY;
            }
            if (ballY > canvas.height) {
                ballSpeedY = -ballSpeedY;
            }
            
            //Cateyes
            if (ballX < 400) {
                document.getElementById("eyeleft").style.left = "47.5%";
                document.getElementById("nose").style.left = "49%";
            }
            if (ballX > 400) {
                document.getElementById("eyeleft").style.left = "48.5%"; 
                document.getElementById("nose").style.left = "50%";           
            }
            if (ballX < 400) {
                document.getElementById("eyeright").style.left = "50.5%";
            }
            if (ballX > 400) {
                document.getElementById("eyeright").style.left = "51.5%";            
            }
        } //function moveEverything


        function drawEverything() {
            
            //Canvas play area
            colorRect(0, 0, canvas.width, canvas.height, "purple");
           
            //Paddle left
            colorRect(0, paddle1Y, paddleWidth, paddleHeight, "yellow");
           
            //Paddle right
            colorRect(canvas.width-10, paddle2Y, paddleWidth, paddleHeight, "yellow");
         
            //Net
            ctx.strokeStyle = "white";
            ctx.beginPath();
            ctx.setLineDash([10,15]);
            ctx.moveTo(400,580);
            ctx.lineTo(400,20);
            ctx.stroke();
            ctx.fill();
           
            //Ball
            colorCircle(ballX, ballY, 8, "white");


        } //function drawEverything
   
        //Circle draw template
        function colorCircle(centerX, centerY, radius, drawColor) {
            ctx.fillStyle = drawColor;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI*2, true);
            ctx.fill();
        }

        //Rectangle draw template
        function colorRect(leftX, topY, width, height, drawColor) {
            ctx.fillStyle = drawColor;
            ctx.fillRect(leftX, topY, width, height);
        }
    
    </script>

</body>
</html>